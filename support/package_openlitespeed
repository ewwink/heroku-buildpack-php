#!/usr/bin/env bash

set -e

openlitespeed_version="$1"

E_ARG_MISSING=127
E_S3_BUCKET_MISSING=2

basedir="$( cd -P "$( dirname "$0" )" && pwd )"
source "$basedir/../conf/buildpack.conf"

export PATH=${basedir}/../vendor/bin:$PATH

if [ -z "$openlitespeed_version" ]; then
    echo "Usage: $0 <version>" >&2
    exit $E_ARG_MISSING
fi

if [ -z "$PCRE_VERSION" ]; then
    APACHE_PCRE_VERSION=8.34
fi

if [ -z "$APACHE_ZLIB_VERSION" ]; then
    APACHE_ZLIB_VERSION=1.2.8
fi

if [ -z "$EXPAT_VERSION" ]; then
    APACHE_APR_VERSION=1.5.0
fi


pcre_version="$PCRE_VERSION"
zlib_version="$ZLIB_VERSION"
apr_util_version="$EXPAT_VERSION"

tempdir="$( mktemp -t openlitespeed_XXXXXXXX )"
rm -rf $tempdir
mkdir -p $tempdir
cd $tempdir

echo "-----> Downloading dependency zlib ${zlib_version}"

curl -LO "http://zlib.net/zlib-${zlib_version}.tar.gz"
tar -xzvf "zlib-${zlib_version}.tar.gz"

echo "-----> Downloading dependency PCRE ${pcre_version}"

curl -LO "http://sourceforge.net/projects/pcre/files/pcre/${pcre_version}/pcre-${pcre_version}.tar.gz"
tar -xzvf "pcre-${pcre_version}.tar.gz"
cd pcre-${pcre_version}
./configure --prefix=/app/vendor/pcre
make
make install
cd ..

echo "-----> Downloading APACHE ${openlitespeed_version}"
curl -LO "http://mirror.symnds.com/software/Apache/httpd/httpd-${openlitespeed_version}.tar.gz"
tar -xzvf "httpd-${openlitespeed_version}.tar.gz"
cd httpd-${openlitespeed_version}

cd srclib

echo "-----> Downloading dependency APR Utility ${apr_version}"
curl -LO "http://mirror.symnds.com/software/Apache/apr/apr-${apr_version}.tar.gz"
tar -xzvf "apr-${apr_version}.tar.gz"
mv apr-${apr_version} apr

curl -LO "http://mirror.symnds.com/software/Apache/apr/apr-util-${apr_util_version}.tar.gz"
tar -xzvf "apr-util-${apr_util_version}.tar.gz"
mv apr-util-${apr_util_version} apr-util

echo "-----> Compiling Apache"
cd ..
./configure --prefix=/app/vendor/openlitespeed \
			--enable-so \
			--enable-rewrite \
			--enable-mods-shared=all \
			--with-included-apr \
			--enable-expires \
            --enable-headers \
			--enable-deflate \
			--with-included-apr \
			--with-zlib=../zlib-${zlib_version} \
			--with-pcre=/app/vendor/pcre
make
make install
cd /app/vendor/openlitespeed
tar -cvzf $tempdir/openlitespeed-${openlitespeed_version}.tgz .

"$basedir/package-checksum" "$tempdir/openlitespeed-${openlitespeed_version}.tgz"

echo "-----> Done building APACHE package! saved as $tempdir/openlitespeed-${openlitespeed_version}.tgz"

echo "-----------------------------------------------"

echo "---> Uploading package to FTP Server"
while true; do
    read -p "Do you wish to to Upload to FTP Server (y/n)?" yn
    case ${yn} in
        [Yy]* ) "$basedir/ftp-upload" "$tempdir/openlitespeed-${openlitespeed_version}.tgz"; break;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac
done
